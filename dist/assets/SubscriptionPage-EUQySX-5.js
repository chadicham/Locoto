import{j as e,D as r,af as s,Y as n,ao as t,T as i,p as a,L as o,y as l,ab as c,b1 as d,ac as u,am as p,x as h,w as m,ai as x,aV as j,J as f,r as v,aK as y,aM as b,C as g,aN as S,b2 as w}from"./mui-vendor-Cj1s4jkd.js";import{a as C,f as P}from"./react-vendor-YkhZaqhD.js";import{l as k}from"./stripe-vendor-lcDBuklM.js";const E="https://locoto-backend.onrender.com",I=k("pk_test_51Qs9ZTDmgkPAsWEpoIw3ATy4LgFWTtPRRRiwVIRyXfczUIs3p2NJJDY5cf1NvnxFuiCetgyhD0FWRPzGTyKjJ1eq00certqBre");const A=new class{getPriceIdFromPlan(e){return{starter:"price_1Qs9siDmgkPAsWEpdYRmXcz0",pro:"price_1QsPtxDmgkPAsWEpvjS0xOnJ",business:"price_1QsPudDmgkPAsWEpWCU9ud64",unlimited:"price_1QsPvkDmgkPAsWEpgTvhFkn3"}[e]}async checkSession(e){try{const r=await fetch(`${E}/api/subscriptions/check-session?session_id=${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!r.ok)throw new Error("Erreur lors de la vérification de la session");return await r.json()}catch(r){throw new Error("Erreur lors de la vérification de la session")}}async initiateSubscription(e){try{this.getPriceIdFromPlan(e);const r=await fetch(`${E}/api/subscriptions/create-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({planId:e})});if(!r.ok){const e=await r.json();throw new Error(e.message||"Erreur lors de la création de la session")}const s=await r.json(),n=await I,{error:t}=await n.redirectToCheckout({sessionId:s.sessionId});if(t)throw t}catch(r){throw new Error("Erreur lors de l'initialisation du paiement")}}async getCurrentSubscription(){try{const e=await fetch(`${E}/api/subscriptions/current`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok)throw new Error("Erreur lors de la récupération de l'abonnement");return await e.json()}catch(e){throw new Error("Erreur lors de la récupération de l'abonnement")}}async cancelSubscription(e){try{const r=await fetch(`${E}/api/subscriptions/cancel`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(e)});if(!r.ok){const e=await r.json();throw new Error(e.message||"Erreur lors de l'annulation")}return await r.json()}catch(r){throw new Error("Erreur lors de l'annulation de l'abonnement")}}},z=({open:j,onClose:f,plan:v,onSuccess:y})=>{const[b,g]=C.useState(!1),[S,w]=C.useState(null);return e.jsxs(r,{open:j,onClose:b?void 0:f,maxWidth:"sm",fullWidth:!0,children:[e.jsx(s,{children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(t,{color:"primary"}),e.jsx(i,{variant:"h6",children:"Confirmation d'abonnement"})]})}),e.jsxs(a,{children:[e.jsxs(n,{sx:{mb:3},children:[e.jsxs(i,{variant:"subtitle1",gutterBottom:!0,children:[v.name," - ",v.price,"CHF/mois"]}),e.jsx(i,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Vous allez être redirigé vers notre plateforme de paiement sécurisée pour finaliser votre abonnement."}),e.jsxs(o,{dense:!0,children:[e.jsxs(l,{children:[e.jsx(c,{children:e.jsx(d,{color:"primary",fontSize:"small"})}),e.jsx(u,{primary:`Jusqu'à ${v.vehicles||"illimité"} véhicules`})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsx(d,{color:"primary",fontSize:"small"})}),e.jsx(u,{primary:"Paiement sécurisé",secondary:"Vos informations bancaires sont chiffrées"})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsx(d,{color:"primary",fontSize:"small"})}),e.jsx(u,{primary:"Sans engagement",secondary:"Annulation possible à tout moment"})]})]})]}),S&&e.jsx(p,{severity:"error",sx:{mt:2},children:S})]}),e.jsxs(h,{sx:{p:2,pt:0},children:[e.jsx(m,{onClick:f,disabled:b,children:"Annuler"}),e.jsx(m,{variant:"contained",onClick:async()=>{try{g(!0),w(null),await A.initiateSubscription(v.id)}catch(e){w(e.message)}finally{g(!1)}},disabled:b,startIcon:b?e.jsx(x,{size:20}):null,children:b?"Traitement en cours...":"Procéder au paiement"})]})]})},W=({open:t,onClose:o,currentPlan:l,onSuccess:c})=>{const[d,u]=C.useState(""),[v,y]=C.useState(!1),[b,g]=C.useState(null);return e.jsxs(r,{open:t,onClose:v?void 0:o,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(j,{color:"warning"}),e.jsx(i,{variant:"h6",children:"Annuler l'abonnement"})]}),e.jsxs(a,{children:[e.jsxs(n,{sx:{mb:3},children:[e.jsxs(i,{variant:"subtitle1",gutterBottom:!0,children:["Êtes-vous sûr de vouloir annuler votre abonnement ",l," ?"]}),e.jsx(i,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Votre abonnement restera actif jusqu'à la fin de la période de facturation en cours. Après cela, vous reviendrez automatiquement au forfait gratuit."}),e.jsx(f,{fullWidth:!0,multiline:!0,rows:3,label:"Raison de l'annulation (facultatif)",value:d,onChange:e=>u(e.target.value),placeholder:"Aidez-nous à nous améliorer en nous indiquant la raison de votre départ",sx:{mt:2}})]}),b&&e.jsx(p,{severity:"error",sx:{mt:2},children:b})]}),e.jsxs(h,{sx:{p:2,pt:0},children:[e.jsx(m,{onClick:o,disabled:v,children:"Retour"}),e.jsx(m,{color:"error",variant:"contained",onClick:async()=>{try{y(!0),g(null);const e=await A.cancelSubscription({reason:d});c(e),o()}catch(e){g(e.message)}finally{y(!1)}},disabled:v,startIcon:v?e.jsx(x,{size:20}):null,children:v?"Annulation en cours...":"Confirmer l'annulation"})]})]})},T=[{id:"free",name:"Gratuit",price:0,vehicles:1,features:["1 véhicule","Contrats illimités","Support par email"],isPopular:!1},{id:"starter",name:"Starter",price:10,vehicles:3,features:["3 véhicules","Contrats illimités","Support prioritaire"],isPopular:!0},{id:"pro",name:"Pro",price:15,vehicles:5,features:["5 véhicules","Contrats illimités","Support téléphonique"],isPopular:!1},{id:"business",name:"Business",price:30,vehicles:10,features:["10 véhicules","Contrats illimités","Support dédié"],isPopular:!1},{id:"unlimited",name:"Illimité",price:60,vehicles:null,features:["Véhicules illimités","Contrats illimités","Support prioritaire 24/7"],isPopular:!1}],B=()=>{var r,s;const t=P(),[a,h]=C.useState("free"),[j,f]=C.useState(null),[k,E]=C.useState(!0),[I,B]=C.useState(null),[D,F]=C.useState(null),[$,J]=C.useState(!1),[R,q]=C.useState(null);C.useEffect(()=>{var e;(null==(e=t.state)?void 0:e.success)&&(q("Votre abonnement a été mis à jour avec succès !"),window.history.replaceState({},document.title)),V()},[t]);const V=async()=>{try{E(!0),B(null);const e=await A.getCurrentSubscription();F(e),h(e.planId)}catch(e){B("Erreur lors du chargement de l'abonnement")}finally{E(!1)}};return k?e.jsx(n,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(x,{})}):e.jsxs(n,{sx:{p:2,pb:8},children:[e.jsx(i,{variant:"h5",sx:{mb:3,fontWeight:600},children:"Abonnement"}),R&&e.jsx(p,{severity:"success",sx:{mb:3},children:R}),I&&e.jsx(p,{severity:"error",sx:{mb:3},children:I}),e.jsxs(v,{sx:{p:3,mb:4},children:[e.jsx(i,{variant:"subtitle1",sx:{mb:1},children:"Forfait actuel"}),e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(i,{variant:"h6",color:"primary",sx:{mb:1},children:(null==(r=T.find(e=>e.id===a))?void 0:r.name)||"Gratuit"}),D&&e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Prochain renouvellement : ",new Date(D.currentPeriodEnd).toLocaleDateString()]})]}),"free"!==a&&e.jsx(m,{color:"error",variant:"outlined",onClick:()=>J(!0),children:"Annuler l'abonnement"})]})]}),e.jsx(y,{container:!0,spacing:3,children:T.map(r=>e.jsx(y,{item:!0,xs:12,md:4,children:e.jsxs(b,{sx:{height:"100%",position:"relative",...r.isPopular&&{border:"2px solid",borderColor:"primary.main"}},children:[r.isPopular&&e.jsx(g,{label:"Plus populaire",color:"primary",size:"small",sx:{position:"absolute",top:-12,right:16}}),e.jsxs(S,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:r.name}),e.jsxs(i,{variant:"h4",color:"primary",gutterBottom:!0,children:[r.price," CHF",e.jsx(i,{component:"span",variant:"body2",color:"text.secondary",children:"/mois"})]}),e.jsx(o,{dense:!0,children:r.features.map((r,s)=>e.jsxs(l,{disableGutters:!0,children:[e.jsx(c,{sx:{minWidth:36},children:e.jsx(d,{color:"primary",fontSize:"small"})}),e.jsx(u,{primary:r})]},s))})]}),e.jsx(w,{sx:{p:2,pt:0},children:e.jsx(m,{fullWidth:!0,variant:a===r.id?"outlined":"contained",onClick:()=>(e=>{e.id!==a&&f(e)})(r),disabled:a===r.id,children:a===r.id?"Forfait actuel":"Sélectionner"})})]})},r.id))}),j&&e.jsx(z,{open:!!j,onClose:()=>f(null),plan:j,onSuccess:()=>{f(null),V()}}),e.jsx(W,{open:$,onClose:()=>J(!1),currentPlan:null==(s=T.find(e=>e.id===a))?void 0:s.name,onSuccess:()=>{V(),J(!1)}})]})};export{B as default};
