import{j as e,D as s,af as i,p as l,am as r,Y as t,T as n,x as a,w as o,aO as c,ai as u,aP as d,aQ as h,aR as m,I as x,aS as p,J as j,aK as v,a2 as g,aa as b,aT as y,aU as f,aV as C,aW as S,aX as q,a1 as P,aY as k,aZ as z,aM as R,a_ as w,C as I}from"./mui-vendor-Cj1s4jkd.js";import{a as T}from"./react-vendor-YkhZaqhD.js";import{v as W}from"./vehicleService-BscnggLA.js";import"./axiosConfig-kM0HH6AN.js";const A=["Voiture","Moto","Scooter"],L={Voiture:["Climatisation","GPS","Bluetooth","Siège bébé","Régulateur de vitesse","Caméra de recul","Toit ouvrant","Audio premium"],Moto:["ABS","Régulateur de vitesse","GPS","Top case","Valises latérales","Protège-mains","Bulle réglable"],Scooter:["Top case","Pare-brise","Support smartphone","ABS","Coffre sous selle","Port USB"]},B={Voiture:["Essence","Diesel","Hybride","Électrique"],Moto:["Essence","Électrique"],Scooter:["Essence","Électrique"]},V=({open:C,onClose:S,onSuccess:q})=>{const[P,k]=T.useState({brand:"",model:"",type:"",licensePlate:"",fuel:"",year:(new Date).getFullYear(),mileage:"",dailyRate:"",description:"",features:[],images:[],engineSize:"",seats:"",documents:{insurance:null,registration:null}}),[z,R]=T.useState([]),[w,I]=T.useState(!1),[V,M]=T.useState(null),[E,U]=T.useState(0),D=()=>{const e={};switch(E){case 0:P.brand||(e.brand="La marque est requise"),P.model||(e.model="Le modèle est requis"),P.type||(e.type="Le type de véhicule est requis"),P.licensePlate||(e.licensePlate="L'immatriculation est requise");break;case 1:P.fuel||(e.fuel="Le type de carburant est requis"),P.mileage||(e.mileage="Le kilométrage est requis"),P.mileage<0&&(e.mileage="Le kilométrage doit être positif"),P.dailyRate||(e.dailyRate="Le tarif journalier est requis"),P.dailyRate<=0&&(e.dailyRate="Le tarif doit être supérieur à 0"),"Voiture"!==P.type||P.seats||(e.seats="Le nombre de places est requis"),"Moto"!==P.type&&"Scooter"!==P.type||P.engineSize||(e.engineSize="La cylindrée est requise");break;case 2:0===z.length&&(e.images="Au moins une photo est requise")}return M(Object.keys(e).length>0?e:null),0===Object.keys(e).length},F=e=>{const{name:s,value:i}=e.target;k(e=>({...e,[s]:i,..."type"===s&&{features:[],fuel:""}})),(null==V?void 0:V[s])&&M(e=>({...e,[s]:null}))},H=e=>{const s=Array.from(e.target.files);if(s.length+z.length>5)return void M(e=>({...e,images:"Maximum 5 images autorisées"}));const i=s.filter(e=>{const s=e.type.startsWith("image/"),i=e.size<=5242880;return s&&i});i.length!==s.length&&M(e=>({...e,images:"Certains fichiers ont été ignorés (format invalide ou taille > 5MB)"}));const l=i.map(e=>({file:e,preview:URL.createObjectURL(e)}));R(e=>[...e,...l]),k(e=>({...e,images:[...e.images,...i]}))};return e.jsxs(s,{open:C,onClose:w?void 0:S,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"50vh"}},children:[e.jsx(i,{children:"Ajouter un véhicule"}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),D())try{I(!0),M(null),await W.createVehicle(P),q()}catch(s){M({submit:s.message||"Une erreur est survenue lors de la création du véhicule"})}finally{I(!1)}},children:[e.jsxs(l,{children:[(null==V?void 0:V.submit)&&e.jsx(r,{severity:"error",sx:{mb:2},children:V.submit}),e.jsx(t,{sx:{mb:3},children:e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Étape ",E+1," sur 3"]})}),(()=>{switch(E){case 0:return e.jsxs(v,{container:!0,spacing:2,children:[e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"brand",label:"Marque",value:P.brand,onChange:F,error:!!(null==V?void 0:V.brand),helperText:null==V?void 0:V.brand,required:!0,fullWidth:!0})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"model",label:"Modèle",value:P.model,onChange:F,error:!!(null==V?void 0:V.model),helperText:null==V?void 0:V.model,required:!0,fullWidth:!0})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{select:!0,name:"type",label:"Type de véhicule",value:P.type,onChange:F,error:!!(null==V?void 0:V.type),helperText:null==V?void 0:V.type,required:!0,fullWidth:!0,children:A.map(s=>e.jsx(g,{value:s,children:s},s))})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"licensePlate",label:"Immatriculation",value:P.licensePlate,onChange:F,error:!!(null==V?void 0:V.licensePlate),helperText:null==V?void 0:V.licensePlate,required:!0,fullWidth:!0})})]});case 1:return e.jsxs(e.Fragment,{children:[e.jsxs(v,{container:!0,spacing:2,children:[e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{select:!0,name:"fuel",label:"Carburant",value:P.fuel,onChange:F,error:!!(null==V?void 0:V.fuel),helperText:null==V?void 0:V.fuel,required:!0,fullWidth:!0,children:P.type&&B[P.type].map(s=>e.jsx(g,{value:s,children:s},s))})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"year",label:"Année",type:"number",value:P.year,onChange:F,required:!0,fullWidth:!0,InputProps:{inputProps:{min:1900,max:(new Date).getFullYear()}}})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"mileage",label:"Kilométrage",type:"number",value:P.mileage,onChange:F,error:!!(null==V?void 0:V.mileage),helperText:null==V?void 0:V.mileage,required:!0,fullWidth:!0,InputProps:{endAdornment:e.jsx(n,{variant:"body2",children:"km"})}})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(j,{name:"dailyRate",label:"Tarif journalier",type:"number",value:P.dailyRate,onChange:F,error:!!(null==V?void 0:V.dailyRate),helperText:null==V?void 0:V.dailyRate,required:!0,fullWidth:!0,InputProps:{startAdornment:e.jsx(n,{variant:"body2",children:"CHF"})}})}),P.type&&e.jsx(v,{item:!0,xs:12,sm:6,children:"Voiture"===P.type?e.jsx(j,{name:"seats",label:"Nombre de places",type:"number",value:P.seats,onChange:F,error:!!(null==V?void 0:V.seats),helperText:null==V?void 0:V.seats,required:!0,fullWidth:!0,InputProps:{inputProps:{min:1,max:9}}}):e.jsx(j,{name:"engineSize",label:"Cylindrée",type:"number",value:P.engineSize,onChange:F,error:!!(null==V?void 0:V.engineSize),helperText:null==V?void 0:V.engineSize,required:!0,fullWidth:!0,InputProps:{endAdornment:e.jsx(n,{variant:"body2",children:"cm³"}),inputProps:{min:0}}})})]}),e.jsx(b,{sx:{my:3}}),e.jsx(n,{variant:"subtitle1",gutterBottom:!0,children:P.type?`Équipements disponibles pour ${P.type}`:"Équipements"}),P.type?e.jsx(v,{container:!0,spacing:1,children:L[P.type].map(s=>e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(y,{control:e.jsx(f,{checked:P.features.includes(s),onChange:()=>(e=>{k(s=>({...s,features:s.features.includes(e)?s.features.filter(s=>s!==e):[...s.features,e]}))})(s)}),label:s})},s))}):e.jsx(n,{color:"text.secondary",children:"Veuillez d'abord sélectionner un type de véhicule"})]});case 2:return e.jsxs(e.Fragment,{children:[e.jsxs(t,{sx:{mb:3},children:[e.jsx(n,{variant:"subtitle1",gutterBottom:!0,children:"Photos du véhicule"}),e.jsx(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Ajoutez jusqu'à 5 photos de votre véhicule. Première photo = photo principale"}),e.jsxs(o,{variant:"outlined",component:"label",startIcon:e.jsx(d,{}),disabled:z.length>=5,sx:{mt:1},children:["Ajouter des photos",e.jsx("input",{type:"file",hidden:!0,accept:"image/*",multiple:!0,onChange:H})]}),(null==V?void 0:V.images)&&e.jsx(n,{color:"error",variant:"caption",sx:{display:"block",mt:1},children:V.images})]}),z.length>0&&e.jsx(h,{cols:3,rowHeight:160,gap:8,children:z.map((s,i)=>e.jsxs(m,{children:[e.jsx("img",{src:s.preview,alt:`Véhicule ${i+1}`,loading:"lazy",style:{height:"100%",objectFit:"cover"}}),e.jsx(x,{sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0, 0, 0, 0.5)","&:hover":{bgcolor:"rgba(0, 0, 0, 0.7)"}},onClick:()=>(e=>{URL.revokeObjectURL(z[e].preview),R(s=>s.filter((s,i)=>i!==e)),k(s=>({...s,images:s.images.filter((s,i)=>i!==e)}))})(i),children:e.jsx(p,{sx:{color:"white"}})})]},i))}),e.jsx(j,{name:"description",label:"Description",value:P.description,onChange:F,multiline:!0,rows:4,fullWidth:!0,sx:{mt:3}})]});default:return null}})()]}),e.jsxs(a,{sx:{p:2,pt:0},children:[e.jsx(o,{onClick:S,disabled:w,children:"Annuler"}),E>0&&e.jsx(o,{onClick:()=>{U(e=>e-1)},disabled:w,children:"Précédent"}),E<2?e.jsx(o,{onClick:()=>{D()&&U(e=>e+1)},variant:"contained",endIcon:e.jsx(c,{}),children:"Suivant"}):e.jsx(o,{type:"submit",variant:"contained",disabled:w,startIcon:w&&e.jsx(u,{size:20}),children:w?"Enregistrement...":"Enregistrer"})]})]})]})},M=({open:c,vehicle:d,onClose:h,onSuccess:m})=>{const[x,p]=T.useState(!1),[j,v]=T.useState(null);return e.jsxs(s,{open:c,onClose:x?void 0:h,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(C,{color:"error"}),e.jsx(n,{variant:"h6",children:"Supprimer le véhicule"})]}),e.jsxs(l,{children:[e.jsxs(t,{sx:{mb:3},children:[e.jsx(n,{variant:"subtitle1",gutterBottom:!0,children:"Êtes-vous sûr de vouloir supprimer le véhicule suivant ?"}),e.jsxs(t,{sx:{p:2,bgcolor:"background.default",borderRadius:1,mt:2},children:[e.jsxs(n,{variant:"body1",gutterBottom:!0,children:[null==d?void 0:d.brand," ",null==d?void 0:d.model]}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Immatriculation : ",null==d?void 0:d.licensePlate]})]}),e.jsx(n,{variant:"body2",color:"error",sx:{mt:2},children:"Cette action est irréversible. L'historique des locations sera conservé mais le véhicule ne pourra plus être utilisé pour de nouvelles locations."})]}),j&&e.jsx(r,{severity:"error",sx:{mt:2},children:j})]}),e.jsxs(a,{sx:{p:2,pt:0},children:[e.jsx(o,{onClick:h,disabled:x,children:"Annuler"}),e.jsx(o,{onClick:async()=>{try{p(!0),v(null);if((await W.getVehicleById(d.id)).isRented)return void v("Ce véhicule ne peut pas être supprimé car il a des locations en cours");await W.deleteVehicle(d.id),m()}catch(e){v(e.message||"Une erreur est survenue lors de la suppression")}finally{p(!1)}},variant:"contained",color:"error",disabled:x,startIcon:x&&e.jsx(u,{size:20}),children:x?"Suppression...":"Supprimer"})]})]})},E=()=>{const[s,i]=T.useState([]),[l,a]=T.useState(!0),[o,c]=T.useState(null),[d,h]=T.useState(!1),[m,j]=T.useState(!1),[b,y]=T.useState(null),[f,C]=T.useState(null);T.useEffect(()=>{A()},[]);const A=async()=>{try{a(!0),c(null);const e=await W.getVehicles();i(e)}catch(e){c("Erreur lors du chargement des véhicules")}finally{a(!1)}},L=()=>{C(null),y(null)},B=({vehicle:s})=>e.jsxs(R,{sx:{height:"100%",p:2},children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsxs(n,{variant:"h6",children:[s.brand," ",s.model]}),e.jsx(x,{onClick:e=>((e,s)=>{C(e.currentTarget),y(s)})(e,s),children:e.jsx(w,{})})]}),e.jsx(n,{color:"text.secondary",gutterBottom:!0,children:s.licensePlate}),e.jsxs(v,{container:!0,spacing:1,sx:{mb:2},children:[e.jsxs(v,{item:!0,xs:6,children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"Type"}),e.jsx(n,{variant:"body1",children:s.type})]}),e.jsxs(v,{item:!0,xs:6,children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"Carburant"}),e.jsx(n,{variant:"body1",children:s.fuel})]})]}),e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(I,{label:s.isAvailable?"Disponible":"Indisponible",color:s.isAvailable?"success":"default",size:"small"}),e.jsxs(n,{variant:"h6",color:"primary",children:[s.dailyRate," CHF/jour"]})]})]});return l?e.jsx(t,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(u,{})}):e.jsxs(t,{sx:{p:3},children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(n,{variant:"h5",fontWeight:600,children:"Mes véhicules"}),e.jsx(S,{color:"primary","aria-label":"Ajouter un véhicule",onClick:()=>h(!0),size:"medium",children:e.jsx(q,{})})]}),o&&e.jsx(r,{severity:"error",sx:{mb:3},children:o}),e.jsxs(v,{container:!0,spacing:3,children:[s.map(s=>e.jsx(v,{item:!0,xs:12,sm:6,md:4,children:e.jsx(B,{vehicle:s})},s.id)),0===s.length&&!l&&e.jsx(v,{item:!0,xs:12,children:e.jsx(r,{severity:"info",children:"Vous n'avez pas encore ajouté de véhicule. Cliquez sur le bouton + pour commencer."})})]}),e.jsxs(P,{anchorEl:f,open:Boolean(f),onClose:L,children:[e.jsxs(g,{onClick:()=>{L()},children:[e.jsx(k,{sx:{mr:1},fontSize:"small"})," Modifier"]}),e.jsxs(g,{onClick:()=>{L()},children:[e.jsx(z,{sx:{mr:1},fontSize:"small"})," Historique"]}),e.jsxs(g,{onClick:()=>{j(!0),L()},sx:{color:"error.main"},children:[e.jsx(p,{sx:{mr:1},fontSize:"small"})," Supprimer"]})]}),d&&e.jsx(V,{open:d,onClose:()=>h(!1),onSuccess:()=>{h(!1),A()}}),m&&b&&e.jsx(M,{open:m,vehicle:b,onClose:()=>j(!1),onSuccess:()=>{j(!1),A()}})]})};export{E as default};
